@model Demo01.WebApi.ViewModels.ForecastPlanningViewModel
@using System.Globalization

@{
    ViewData["Title"] = "Forecast Planning";
    var processes = Model.AllProcesses ?? new List<Demo01.Infrastructure.Entities.Process>();
}

<div class="container mt-3">
    <h2>Forecast Planning</h2>

    <form method="get" class="row g-3 align-items-end mb-3">

        <div class="col-md-3">
            <label class="form-label">Forecast</label>
            <select name="forecastId" class="form-select" onchange="this.form.submit()">
                @foreach (var f in Model.Forecasts)
                {
                    <option value="@f.ForecastId" selected="@(f.ForecastId == Model.SelectedForecastId)">
                        @f.DisplayName
                    </option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Week</label>
            <select name="weekId" class="form-select" onchange="this.form.submit()">
                @foreach (var w in Model.Weeks)
                {
                    <option value="@w.ForecastWeekId" selected="@(w.ForecastWeekId == Model.SelectedWeekId)">
                        @w.DisplayName
                    </option>
                }
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Department</label>
            <select name="departmentId" class="form-select" onchange="this.form.submit()">
                @foreach (var d in Model.Departments)
                {
                    <option value="@d.DepartmentId" selected="@(d.DepartmentId == Model.SelectedDepartmentId)">
                        @d.Name
                    </option>
                }
            </select>
        </div>

        <div class="col-md-2 d-flex align-items-center">
            <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" name="hasSaturday" value="true"
                       id="hasSaturday" @(Model.HasSaturday ? "checked" : "") />
                <label class="form-check-label" for="hasSaturday">Need Saturday</label>
            </div>
        </div>

        <!-- Gộp Target + Total Hour chung 1 hàng -->
        <div class="col-md-2">
            <label class="form-label d-block">Summary</label>
            <div class="input-group input-group-sm">
                <span class="input-group-text fw-bold">Target (LF)</span>
                <input type="text" class="form-control text-end"
                       value="@(Model.TargetLf.ToString("0.##"))" disabled />
            </div>
            <div class="input-group input-group-sm mt-1">
                <span class="input-group-text fw-bold">Total (h)</span>
                <input type="text" id="totalHourInput" class="form-control text-end"
                       value="@(Model.TotalHour.ToString("0.##"))" disabled />
            </div>
        </div>

    </form>

    <hr />

    @if (Model.SelectedWeek != null)
    {
        <table class="table table-bordered table-sm align-middle text-center mt-3">
            <thead class="table-light">
                <tr>
                    <th></th>
                    @foreach (var day in Model.DatesInWeek)
                    {
                        <th>@day.ToString("dd/MM")</th>
                    }
                </tr>
                <tr>
                    <th></th>
                    @foreach (var day in Model.DatesInWeek)
                    {
                        <th>@day.ToString("dddd", new CultureInfo("vi-VN"))</th>
                    }
                </tr>
            </thead>
            <tbody>
                <!-- Nhóm dòng Work hour -->
                @foreach (var process in processes)
                {
                    <tr class="table-secondary">
                        <td class="fw-bold text-start">Work hours @process.Name</td>
                        @foreach (var day in Model.DatesInWeek)
                        {
                            var dateOnly = DateOnly.FromDateTime(day.DateTime);
                            var record = Model.PlanningProcesses
                                .FirstOrDefault(p => p.ProcessId == process.Id && p.ForecastPlanning.PlanningDate == dateOnly);

                            var isHoliday = Model.HolidayList.Contains(DateOnly.FromDateTime(day.DateTime));
                            var disabled = ((!Model.HasSaturday && day.DayOfWeek == DayOfWeek.Saturday) || isHoliday) ? "disabled" : "";

                            <td>
                                <input type="number" step="0.01" class="form-control form-control-sm text-center"
                                       name="@($"workingHour_{process.Id}_{day:yyyyMMdd}")"
                                       value="@(record != null ? record.WorkingHour.ToString("0.##") : "0")"
                                       @disabled />
                            </td>
                        }
                    </tr>
                }

                <!-- Nhóm dòng process chính -->
                @foreach (var process in processes)
                {
                    <tr>
                        <td class="fw-bold text-start">@process.Name</td>
                        @foreach (var day in Model.DatesInWeek)
                        {
                            var isHoliday = Model.HolidayList.Contains(DateOnly.FromDateTime(day.DateTime));
                            var disabled = ((!Model.HasSaturday && day.DayOfWeek == DayOfWeek.Saturday) || isHoliday) ? "disabled" : "";

                            var record = Model.PlanningProcesses.FirstOrDefault(p => p.ProcessId == process.Id);
                            <td>
                                <input type="number" step="0.01" class="form-control form-control-sm text-center"
                                       name="@($"actualLf_{process.Id}_{day:yyyyMMdd}")"
                                       value="@(record != null ? record.ActualLf.ToString("0.##") : "0")"
                                       @disabled />
                            </td>
                        }
                    </tr>
                }

                <!-- Dòng Target -->
                <tr>
                    <td class="fw-bold text-start">Target (LF)</td>
                    @foreach (var day in Model.DatesInWeek)
                    {
                        var firstRecord = Model.PlanningProcesses
                            .FirstOrDefault(p => p.ForecastPlanning.PlanningDate == DateOnly.FromDateTime(day.DateTime));

                        <td>
                            <input type="text" class="form-control form-control-sm text-center"
                                   value="@(firstRecord != null ? firstRecord.TargetLf.ToString("0.##") : "0")"
                                   disabled />
                        </td>
                    }
                </tr>
            </tbody>
        </table>
    }
</div>

<script>
    const debounce = (func, delay) => {
        let timer;
        return function (...args) {
            clearTimeout(timer);
            timer = setTimeout(() => func.apply(this, args), delay);
        };
    };

    async function saveWorkingHour(input) {
        const name = input.name;
        const value = parseFloat(input.value) || 0;
        const [_, processId, dateStr] = name.split('_');

        const res = await fetch('/ForecastPlanning/UpdateWorkingHour', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                processId: processId,
                date: dateStr,
                workingHour: value,
                forecastWeekId: '@Model.SelectedWeekId',
                forecastId: '@Model.SelectedForecastId',
                departmentId: '@Model.SelectedDepartmentId'
            })
        });

        if (res.ok) {
            // Reload lại trang, giữ query string
            const url = new URL(window.location.href);
            window.location.href = url.toString();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Auto-save working hours
        document.querySelectorAll('input[name^="workingHour_"]').forEach(input => {
            input.addEventListener('input', debounce(e => {
                saveWorkingHour(e.target);
            }, 700));
        });

        // Update HasSaturday flag
        const chk = document.getElementById('hasSaturday');
        chk.addEventListener('change', async () => {
            await fetch('/ForecastPlanning/UpdateHasSaturday', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    forecastWeekId: '@Model.SelectedWeekId',
                    hasSaturday: chk.checked
                })
            });

            // Sau khi cập nhật xong reload lại trang để cập nhật UI
            const url = new URL(window.location.href);
            //url.searchParams.set('hasSaturday', chk.checked ? 'true' : 'false');
            window.location.href = url.toString();
        });
    });
</script>
